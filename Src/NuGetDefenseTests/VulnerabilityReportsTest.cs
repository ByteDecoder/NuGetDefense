using System.Collections.Generic;
using NuGetDefense;
using NuGetDefense.Core;
using Xunit;
using static NuGetDefense.UtilityMethods;

namespace NuGetDefenseTests
{
    public class VulnerabilityReportsTest
    {
        [Fact]
        public void ReportVulnerabilityWithNullReferences()
        {
            var vulnDict = new Dictionary<string, Dictionary<string, Vulnerability>>
            {
                {
                    "TestPkg", new Dictionary<string, Vulnerability>
                    {
                        {
                            "CVE-Test", new Vulnerability(
                            
                                "CVE-Test",
                                6.6,
                                "CWE-Test",
                                "Test Description",
                                null,
                                Vulnerability.AccessVectorType.NETWORK,
                                "Test Vendor"
                            )
                        }
                    }
                }
            };

            var pkgs = new[] {new NuGetPackage {LineNumber = 1, Id = "TestPkg", Version = "1.0.1"}};

            var reporter = new VulnerabilityReporter();
            reporter.BuildVulnerabilityTextReport(vulnDict, pkgs, "NuGetDefense.dll", false, 0D, out var vulnNumber);
            Assert.Equal(0, vulnNumber);
            //TODO: Assert MSBuildMessages and VulnerabilityReport
        }

        [Fact]
        public void IgnoreVulnerabilitiesForPackage()
        {
            var pkgs = new[]
            {
                new NuGetPackage {LineNumber = 1, Id = "TestPkg", Version = "1.0.1"},
                new NuGetPackage {LineNumber = 2, Id = "TestPkg2", Version = "22.32.255"},
                new NuGetPackage {LineNumber = 3, Id = "TestPkg3", Version = "22.32.250"},
                new NuGetPackage {LineNumber = 4, Id = "TestPkg4", Version = "22.32.250"}
            };
            
            var ignorePkgs = new[]
            {
                new NuGetPackage {LineNumber = 1, Id = "TestPkg", Version = "1.0.2"},
                new NuGetPackage {LineNumber = 2, Id = "TestPkg2", Version = "22.32.255"},
                new NuGetPackage {LineNumber = 3, Id = "TestPkg3", Version = ""},
                new NuGetPackage {LineNumber = 4, Id = "TestPkg4", Version = null}
            };

                IgnorePackages(in pkgs, ignorePkgs, out pkgs);
                Assert.True(pkgs.Length == 1);
                Assert.True(pkgs[0].Id == "TestPkg");
                Assert.True(pkgs[0].Version == "1.0.1");
                Assert.True(pkgs[0].LineNumber == 1);
        }
    }
}